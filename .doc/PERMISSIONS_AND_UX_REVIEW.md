# VibeCap 权限与未授权应对 — 说明与 UX 评估

基于当前代码梳理：新用户完整使用所有功能所需的授权、对应功能、未授权时的应对，以及从资深 UX 角度的评估与改进建议。

---

## 一、授权与功能对应表

| 授权类型 | 对应功能 | 触发时机 | Info.plist / 系统 |
|----------|----------|----------|-------------------|
| **屏幕录制 (Screen Recording)** | 选区截图、截屏预览、标注画布、保存/复制截图 | 用户通过菜单或快捷键发起截图时 | 无 plist key，系统弹窗；代码用 `CGPreflightScreenCaptureAccess` / `CGRequestScreenCaptureAccess` |
| **辅助功能 (Accessibility)** | 「复制图片+提示词」后在下个 App 里按 ⌘V 自动粘贴（Copy & Arm） | 用户点击「复制图片与提示词」或点击模态内「启用 →」横幅时 | `NSAccessibilityUsageDescription`：用于自动粘贴到目标 App |
| **登录时启动 (Launch at Login)** | 开机/登录后自动启动 VibeCap | 用户在设置中勾选「登录时打开」时 | 无 plist；`SMAppService.mainApp`，可能需用户在「登录项」中批准 |
| **存储文件夹 (用户选择)** | 保存截图、自动保存到指定文件夹 | 首次保存/自动保存或设置里「选择文件夹」 | 通过 NSOpenPanel 选文件夹 + security-scoped bookmark，非系统权限弹窗 |

**不依赖用户授权的部分：**

- **剪贴板读写**：仅复制图片/文字到剪贴板，无需单独权限。
- **网络 (StoreKit)**：IAP 使用 entitlement `com.apple.security.network.client`，非用户可见的「授权」。
- **Pro 能力**：由 EntitlementsService 根据购买状态控制，与系统权限无关。

---

## 二、未授权时的应对措施（当前实现）

### 1. 屏幕录制 — 未授权

| 场景 | 当前行为 |
|------|----------|
| 用户触发截图（菜单/快捷键） | `CaptureManager.startCapture()` 内先调 `captureService.ensurePermissionOrRequest()`；若为 false，弹出 **NSAlert**（`PermissionsUI.showScreenRecordingPermissionAlert()`），文案为「需要屏幕录制权限」+ 引导打开 系统设置 → 隐私与安全性 → 屏幕录制，并提示「退出并重新打开 App」。可选「打开系统设置」或「取消」。不进入选区覆盖层。 |
| 授权后未重启 | 系统通常要重启 App 后权限才生效；当前文案已说明「退出并重新打开」。 |
| 已进入截图流程但权限被撤销（极少见） | `ScreenCaptureService.captureFrozenSnapshot` 抛 `ScreenCaptureError.permissionDenied`，`CaptureManager` 在 catch 里用 `HUDService.shared.show(message: error.localizedDescription, style: .error)` 显示「需要屏幕录制权限才能截屏」。 |

### 2. 辅助功能 — 未授权

| 场景 | 当前行为 |
|------|----------|
| 有辅助功能权限 | 模态底部不显示横幅；按钮为「复制图片」/「复制图片与提示词」；⌘C 可执行「复制图片与提示词」并 Arm。 |
| 无辅助功能权限 | 模态底部显示 **accessibilityHintView** 横幅（浅橙底）：文案「想要同时复制图片与提示词吗？」+「启用 →」。点击横幅会降级窗口、调 `ClipboardAutoPasteService.requestAccessibilityPermission()` 并打开 **系统设置 → 辅助功能**。复制行为：`performCopyAction` 中若 `!hasAccessibilityPermission` 只执行「复制图片」并关模态（不 Arm），仍可用。 |

即：**无辅助功能时功能降级为「仅复制图片」**，不阻止使用。

### 3. 登录时启动 — 未批准

| 场景 | 当前行为 |
|------|----------|
| 用户勾选「登录时打开」且系统返回 `requiresApproval` | `LaunchAtLoginService.setEnabled(true)` 抛 `LaunchAtLoginError.requiresApproval`，设置页已把 `launchAtLogin` 写入 SettingsStore，然后弹出 **NSAlert**（`showLaunchApprovalAlert()`）：标题「需要批准」、说明到 系统设置 → 通用 → 登录项 中启用，按钮「打开登录项」/「确定」。 |

### 4. 存储文件夹 — 未选择或 bookmark 失效

| 场景 | 当前行为 |
|------|----------|
| 未选过保存文件夹且用户点「保存」 | `ScreenshotSaveService.saveToFolderAndReturnURL` 走 `chooseFolder()`，弹出 **NSOpenPanel** 选文件夹，选完后存 bookmark。 |
| 自动保存开启但未配置文件夹 | 复制后若 `currentFolderURL() == nil` 且未展示过提示，则 HUD 提示「要启用自动保存，请点击 [保存] 选择一次保存文件夹」。 |
| bookmark 失效（如文件夹被删/移动） | `resolveFolderURLFromBookmark()` 失败，按「未配置」处理，下次保存时再次弹出 NSOpenPanel 选文件夹。 |

---

## 三、资深 UX 评估与改进建议

### 3.1 做得好的地方

1. **屏幕录制**  
   - 在入口就检查权限，不进入选区再报错，避免「选完才发现不能截」的挫败感。  
   - Alert 提供「打开系统设置」并尝试前置系统设置窗口，路径清晰。  
   - 文案明确提到「退出并重新打开」，符合 macOS 实际行为。

2. **辅助功能**  
   - 采用「降级」而非「禁用」：无权限时仍可「复制图片」，仅高级能力（Copy & Arm）需要权限。  
   - 在需要该能力的上下文中才展示横幅（模态内），并给「启用 →」一步到位跳转，符合「just-in-time」说明。

3. **权限与功能一一对应**  
   - 截图 = 屏幕录制；自动粘贴 = 辅助功能；登录项 = 登录时启动，心智模型清晰。

### 3.2 可改进点

#### 1）屏幕录制：首次体验与「重启」认知

- **问题**：新用户第一次触发截图只会看到一个 Alert，若之前从未用过屏幕录制，可能不知道「重启 App」是必须步骤，容易在开启权限后再次尝试仍失败。  
- **建议**：  
  - 在 Alert 的 informativeText 中把「然后**退出并重新打开 App**」做成单独一句或加粗/换行，避免被忽略。  
  - （可选）在用户从「系统设置」返回且检测到权限仍为 false 时，在菜单栏或下次触发时再给一次简短提醒：「若您已开启屏幕录制，请先退出并重新打开 VibeCap」。

#### 2）辅助功能：横幅时机与「为何要辅助功能」

- **问题**：  
  - 当前只要无权限就显示「想要同时复制图片与提示词吗？」部分用户不清楚「复制图片与提示词」和「辅助功能」的关系，可能产生隐私顾虑。  
  - 若用户从不使用提示词，横幅会一直存在，略占空间且可能被视为打扰。  
- **建议**：  
  - 在横幅或「启用 →」旁增加一句短说明：「用于在您按 ⌘V 时自动粘贴到其他 App」，减少对「为什么需要辅助功能」的疑惑。  
  - 可选：仅当用户输入了提示词或点击过「复制图片与提示词」后再展示该横幅（即：仅在「会用到该能力」时提示），减少对只用「复制图片」用户的干扰。

#### 3）登录时启动：批准流程的可见性

- **问题**：`requiresApproval` 时已把「登录时打开」写入设置，但用户若没去登录项里点一下，实际不会开机启动，容易误以为已经设好。  
- **建议**：  
  - 在设置里「登录时打开」旁用一行小字说明：「首次启用可能需在系统「登录项」中批准」。  
  - 弹 Alert 时再次强调「需在登录项中**勾选 VibeCap** 后才会在登录时启动」。

#### 4）统一「权限/设置」入口（可选）

- **问题**：屏幕录制、辅助功能、登录项分散在系统设置不同页面，新用户可能记不住路径。  
- **建议**：  
  - 在 **设置** 中增加一页「权限与系统集成」，列出：屏幕录制（截图）、辅助功能（自动粘贴）、登录项（登录时启动），每项一行说明 +「打开系统设置」按钮，跳转到对应子页（沿用现有 `PermissionsUI` 的 URL）。  
  - 这样既方便排查「为什么某功能不工作」，也便于一次性完成所有授权。

#### 5）截图中权限被撤销的反馈

- **问题**：若用户在选区阶段或后台权限被关，会得到 HUD 错误文案，但 HUD 很快消失，且没有「打开系统设置」的快捷方式。  
- **建议**：  
  - 对 `ScreenCaptureError.permissionDenied` 使用与入口一致的 Alert（或带「打开系统设置」的 HUD 动作），而不仅是 HUD 文案，避免用户不知道下一步该做什么。

#### 6）屏幕录制在 Info.plist 的说明（可选）

- **问题**：macOS 对屏幕录制不强制要求 Usage Description，但若将来在其它平台或审核需要，缺少统一说明。  
- **建议**：  
  - 在 Info.plist 中增加 `NSScreenCaptureUsageDescription`（若目标系统支持），文案与当前 Alert 一致或更短，例如：「VibeCap 需要屏幕录制权限以截取您选择的区域。」便于维护与审核。

---

## 四、小结

| 授权 | 功能 | 未授权时应对 | UX 评价 |
|------|------|--------------|---------|
| 屏幕录制 | 截图全流程 | 入口 Alert + 跳转系统设置，流程中异常用 HUD | 入口清晰；可加强「重启」提示与异常时的引导 |
| 辅助功能 | Copy & Arm 自动粘贴 | 降级为仅复制图片 + 模态内横幅引导开启 | 降级合理；可补充「为何要辅助功能」与展示时机 |
| 登录时启动 | 开机自启 | Alert 引导到登录项 | 可加强「需在登录项中勾选」的说明与设置页说明 |
| 存储文件夹 | 保存/自动保存 | NSOpenPanel 选文件夹 + bookmark，失效后重选 | 符合 macOS 习惯，无大问题 |

整体上，VibeCap 的权限与功能对应清晰，未授权时以「降级 + 引导」为主，没有粗暴阻断。优先改进「重启 App」的认知、辅助功能的说明与展示时机、以及统一权限入口，会明显提升新用户和首次授权体验。
